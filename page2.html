<!-- Modified page2.html as per new instructions -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Application — Step 2 of 3 — Verification & Reason</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body {
      background: #0e1649;
      min-height: 100vh;
      color: #f0f4ff;
      font-family: 'Inter', sans-serif;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
    }
    main {
      background: #161c3d;
      max-width: 680px;
      width: 100%;
      border-radius: 1.25rem;
      box-shadow: 0 0 32px rgb(59 130 246 / 0.5);
      padding: 2.5rem 2.5rem 3rem;
      user-select: none;
    }
    h1 {
      font-weight: 900;
      font-size: 1.8rem;
      margin-bottom: 0.8rem;
      color: #d3daf5;
      letter-spacing: -0.02em;
      text-align: center;
    }
    p.step-label {
      font-weight: 600;
      text-align: center;
      font-size: 0.95rem;
      margin-bottom: 1.6rem;
      color: #7892c3;
      user-select: none;
    }
    fieldset {
      border: none;
      margin-bottom: 1.5rem;
    }
    legend {
      font-weight: 600;
      font-size: 1.05rem;
      margin-bottom: 0.65rem;
      color: #c1cdfa;
    }
    label {
      display: block;
      margin-bottom: 0.2rem;
      font-weight: 500;
      font-size: 1rem;
      color: #adc0ff;
      user-select: none;
    }
    input, textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border: 2px solid #2641a6;
      background: #1b2361;
      color: #e4e9ff;
      font-size: 1rem;
      transition: border-color 0.3s;
      resize: none;
      font-family: 'Inter', sans-serif;
      margin-bottom: 1rem;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #4f83ff;
      box-shadow: 0 0 8px rgba(79, 131, 255, 0.65);
    }
    textarea {
      min-height: 6.2rem;
      font-size: 1rem;
      line-height: 1.4;
    }
    button.submit-btn {
      width: 100%;
      padding: 1.05rem 0;
      background: linear-gradient(90deg, #5499ff 0%, #2270e1 100%);
      border-radius: 9999px;
      font-weight: 800;
      color: #fff;
      font-size: 1.15rem;
      cursor: pointer;
      box-shadow: 0 6px 20px rgb(40 117 255 / 0.7);
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button.submit-btn:hover {
      background: linear-gradient(90deg, #3164ca 0%, #194b94 100%);
    }
    .error-msg {
      color: #ff6b6b;
      font-weight: 600;
      margin-top: 0.1rem;
      margin-bottom: 1.2rem;
      min-height: 1.2em;
      user-select: none;
    }
    #uploadStatus {
      font-size: 0.9rem;
      margin-bottom: 1rem;
      user-select: none;
      color: #84acff;
    }
    .code-output {
      background: #15225a;
      border-radius: 0.75rem;
      padding: 1rem;
      font-weight: 700;
      font-size: 1.3rem;
      color: #67d37a;
      text-align: center;
      margin-top: 1.3rem;
      letter-spacing: 0.25em;
      user-select: all;
      cursor: default;
      user-select: none;
      font-family: monospace;
      position: relative;
    }
    .countdown-timer {
      margin-top: 0.5rem;
      font-size: 0.93rem;
      text-align: center;
      color: #a3c0ffcc;
      user-select: none;
    }
  </style>
</head>
<body>
  <main aria-label="Step 2 of 3 — Verification and Reason">
    <p class="step-label">Step 2 of 3 — Verification & Reason</p>
    <h1>Verification & Admin Appointment Reason</h1>

    <section id="page1summary" aria-live="polite" style="color:#adc0ff; font-weight:600; white-space:pre-line; user-select:none; margin-bottom:1.5rem;">Loading your personal details...</section>

    <form id="page2Form" novalidate autocomplete="off" aria-label="Verification form">
      <fieldset>
        <legend>Email Sign-in (or Google Sign In below)</legend>
        <label for="originalEmail">Original Email ID (for verification)</label>
        <input id="originalEmail" name="originalEmail" type="email" placeholder="your.email@example.com" autocomplete="email"/>

        <label for="originalPassword">Password</label>
        <input id="originalPassword" name="originalPassword" type="password" placeholder="Enter your password" autocomplete="current-password"/>
        <small style="color: #bbc3e6; font-size: 0.8rem; user-select:none;">* Password is client-side hashed only; not secure for production use.</small>
      </fieldset>

      <fieldset aria-label="Google sign in">
        <button id="googleSignInBtn" type="button" style="margin-bottom:1rem; width: 100%; padding: 1rem; background:#2785ff; border:none; border-radius:1rem; color:white; font-weight:700; cursor:pointer; user-select:none;">Continue with Google</button>
      </fieldset>

      <fieldset>
        <label for="reasonTextArea">Reason for Admin (Paste the appointment email conversation here or upload the file)</label>
        <textarea id="reasonTextArea" name="reasonTextArea" required placeholder="Paste the appointment email conversation here..." aria-required="true" spellcheck="false"></textarea>

        <label for="fileInput" style="display:inline-block; cursor:pointer; background: #3755a0; padding: 0.8rem 1.2rem; border-radius: 0.5rem; color: white; font-weight: 600; margin-bottom: 0.5rem; user-select:none;">Attach conversation file (.txt or .eml only, max 2MB)</label>
        <input type="file" id="fileInput" accept=".txt,.eml" style="display:none;" />
        <div id="uploadStatus" role="alert" aria-live="assertive"></div>
      </fieldset>

      <p class="error-msg" id="errorMsg"></p>
      <button type="submit" class="submit-btn" aria-label="Submit Application">Submit Application</button>
    </form>

    <!-- After submission success -->
    <section id="codeSection" hidden aria-live="polite" role="alert" tabindex="0" style="margin-top:2rem; user-select:none;">
      <p style="font-weight:bold; font-size:1.1rem; color:#8ee49f; margin-bottom:8px;">Your authenticated 10-digit code has been generated and saved securely.</p>
      <div class="code-output" id="authCodeDisplay"></div>
      <div class="countdown-timer" id="countdownTimer">Visible for 03:00</div>
      <button id="nextBtn" class="submit-btn" style="margin-top:1.5rem;">Next</button>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>

  <script>
    // REPLACE with your own Firebase configuration
    const firebaseConfig = {
       apiKey: "AIzaSyAOHLoX1OGHiznYvYeUSkrR2lAxzhVrsGw",
  authDomain: "learn-code-with-anay.firebaseapp.com",
  projectId: "learn-code-with-anay",
  storageBucket: "learn-code-with-anay.firebasestorage.app",
  messagingSenderId: "197075143711",
  appId: "1:197075143711:web:64fc5d83528f907d38d92a",
  measurementId: "G-F01VRZK4ZL"

    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    const urlParams = new URLSearchParams(window.location.search);
    const applicationId = urlParams.get('applicationId');
    const page1summary = document.getElementById('page1summary');
    const errorMsg = document.getElementById('errorMsg');
    const reasonTextArea = document.getElementById('reasonTextArea');
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');
    const codeSection = document.getElementById('codeSection');
    const authCodeDisplay = document.getElementById('authCodeDisplay');
    const countdownTimer = document.getElementById('countdownTimer');
    const nextBtn = document.getElementById('nextBtn');

    let fixedMailCheck = true; // Always true since no visible fixed mail check
    let attachedFileURL = null;
    let googleUserUid = null;
    let usedGoogleSignIn = false;

    // Load application data summary from Firestore
    async function loadPage1Data() {
      if (!applicationId) {
        page1summary.textContent = 'No application ID found. Please restart the process.';
        return;
      }
      try {
        const doc = await db.collection('adminApplications').doc(applicationId).get();
        if (!doc.exists) {
          page1summary.textContent = 'Application not found for the given ID.';
          return;
        }
        const data = doc.data();
        const p1 = data.page1Data || {};
        page1summary.textContent = `Name: ${p1.fullName || '-'}\nAddress: ${p1.address || '-'}\nMobile: ${p1.mobileNumber || '-'}`;
      } catch (err) {
        page1summary.textContent = 'Failed to load application details. Refresh and retry.';
        console.error(err);
      }
    }

    loadPage1Data();

    fileInput.addEventListener('change', async () => {
      uploadStatus.textContent = '';
      attachedFileURL = null;
      if (fileInput.files.length === 0) return;
      const file = fileInput.files[0];

      if (file.size > 2 * 1024 * 1024) {
        uploadStatus.textContent = 'File size exceeds 2MB limit.';
        fileInput.value = '';
        return;
      }
      const allowedTypes = ['text/plain', 'message/rfc822', 'application/octet-stream'];
      if (!allowedTypes.includes(file.type) && !file.name.toLowerCase().endsWith('.eml') && !file.name.toLowerCase().endsWith('.txt')) {
        uploadStatus.textContent = 'Only .txt or .eml files are allowed.';
        fileInput.value = '';
        return;
      }

      // Upload file to Firebase Storage directly (no fixed mail check on content)
      uploadStatus.textContent = 'Uploading file...';
      try {
        const fileRef = storage.ref().child(`applicationUploads/${applicationId}_${Date.now()}_${file.name}`);
        await fileRef.put(file);
        attachedFileURL = await fileRef.getDownloadURL();
        uploadStatus.textContent = 'File uploaded successfully.';
      } catch (err) {
        uploadStatus.textContent = 'Failed to upload file. Try again.';
        console.error(err);
      }
    });

    document.getElementById('googleSignInBtn').addEventListener('click', async () => {
      errorMsg.textContent = '';
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        if (result.user) {
          googleUserUid = result.user.uid;
          usedGoogleSignIn = true;
          document.getElementById('originalEmail').value = result.user.email;
          alert('Google sign-in successful. Please fill reason and submit application.');
        }
      } catch (e) {
        errorMsg.textContent = `Google Sign-in failed: ${e.message}`;
      }
    });

    // Hash password (demo only)
    function hashPassword(pwd) {
      return sha256(pwd);
    }

    document.getElementById('page2Form').addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.textContent = '';
      if (!applicationId) {
        errorMsg.textContent = 'Application ID missing. Please restart.';
        return;
      }
      const originalEmail = e.target.originalEmail.value.trim();
      const originalPassword = e.target.originalPassword.value;
      const reasonText = e.target.reasonTextArea.value.trim();

      if (!reasonText) {
        errorMsg.textContent = 'Reason for Admin is required.';
        return;
      }

      if (originalEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(originalEmail)) {
        errorMsg.textContent = 'Please enter a valid original email address.';
        return;
      }
      if (originalEmail && !usedGoogleSignIn && !originalPassword) {
        errorMsg.textContent = 'Password is required when providing an original email.';
        return;
      }
      const passwordHash = (originalEmail && originalPassword) ? hashPassword(originalPassword) : null;

      try {
        const docRef = db.collection('adminApplications').doc(applicationId);
        const docSnap = await docRef.get();
        const existingData = docSnap.data();

        let code = existingData.authCode || null;
        if (!code) {
          // Generate unique 10-digit code ONLY IF not generated before
          const adminCodesRef = db.collection('adminCodes');
          while (true) {
            code = Array(10).fill(null).map(() => Math.floor(Math.random() * 10)).join('');
            const codeExists = await adminCodesRef.where('code', '==', code).limit(1).get();
            if (codeExists.empty) break;
          }
          // Save in adminCodes collection
          await adminCodesRef.add({
            code,
            applicationId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            used: false
          });
        }

        // Save to adminApplications doc (including authCode)
        await docRef.update({
          originalEmail: originalEmail || '',
          usedGoogleSignIn,
          googleUID: googleUserUid || '',
          reasonText,
          attachedFileURL: attachedFileURL || '',
          fixedMailCheck,
          status: 'submitted',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          passwordHash: passwordHash || '',
          authCode: code
        });

        // Show code with countdown
        document.getElementById('page2Form').hidden = true;
        authCodeDisplay.textContent = code;
        codeSection.hidden = false;
        codeSection.focus();

        startCountdown(180); // 3 minutes countdown

      } catch (err) {
        errorMsg.textContent = 'Failed to submit application. Please try again.';
        console.error(err);
      }
    });

    // Countdown hiding logic (show only first 4 digits after 3 minutes)
    function startCountdown(seconds) {
      let remaining = seconds;
      countdownTimer.textContent = `Visible for ${formatTime(remaining)}`;

      const interval = setInterval(() => {
        remaining--;
        if (remaining >= 0) {
          countdownTimer.textContent = `Visible for ${formatTime(remaining)}`;
        }
        if (remaining === 0) {
          clearInterval(interval);
          countdownTimer.textContent = 'Code partially hidden for security.';
          // Mask code except first 4 digits
          const fullCode = authCodeDisplay.textContent;
          if (fullCode.length >= 4) {
            const masked = fullCode.substring(0, 4) + ' ••••••••';
            authCodeDisplay.textContent = masked;
          }
        }
      }, 1000);
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    // Next button redirect to admin-confirm.html
    nextBtn.addEventListener('click', () => {
      window.location.href = "admin-confirm.html";
    });

  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
</body>
</html>
